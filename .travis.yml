dist: xenial

sudo: required

language: cpp

git:
  depth: false

matrix:
  include:
    - os: linux
      compiler: gcc
      cache:
        directories:
          - $HOME/boost
          - $HOME/json

    - os: linux
      compiler: clang
      cache:
        directories:
          - $HOME/boost
          - $HOME/json

    - os: osx
      osx_image: xcode9.4
      compiler: clang
      cache:
        directories:
          - /usr/local/Cellar/cryptopp
          - $HOME/Library/Caches/Homebrew

    - os: osx
      osx_image: xcode10.2
      compiler: clang
      cache:
        directories:
          - /usr/local/Cellar/cryptopp
          - $HOME/Library/Caches/Homebrew

addons:
  apt:
    packages:
      - doxygen
      - qt5-default
      - qttools5-dev
      - qttools5-dev-tools
      - libcrypto++-dev
      - libcurl4-openssl-dev

before_cache:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew cleanup &&
      rm -rf $HOME/Library/Caches/Homebrew/DCore--git;
    fi

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew tap nlohmann/json &&
      brew tap decentfoundation/DCore;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      test -L /usr/local/opt/cryptopp || test ! -d /usr/local/Cellar/cryptopp || brew link cryptopp || true;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      test ! -L /usr/local/opt/cryptopp || brew upgrade cryptopp || true;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      sed -i '' "s,branch =\> \"develop\",revision =\> \"$TRAVIS_COMMIT\"," /usr/local/Homebrew/Library/Taps/decentfoundation/homebrew-dcore/DCore.rb;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      curl https://bintray.com/user/downloadSubjectPublicKey?username=decentfoundation | sudo apt-key add -;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      sudo add-apt-repository "deb [arch=amd64] https://dl.bintray.com/decentfoundation/ubuntu $(lsb_release -cs) libpbc" &&
      sudo apt-get update &&
      sudo apt-get install -y libpbc-dev;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      test -d $HOME/boost/lib || (wget -nv https://sourceforge.net/projects/boost/files/boost/1.65.1/boost_1_65_1.tar.gz && tar xf boost_1_65_1.tar.gz && cd boost_1_65_1 && ./bootstrap.sh --prefix=$HOME/boost && ./b2 -j$(nproc) install);
    fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      test -d $HOME/json/include || (wget -nv https://github.com/nlohmann/json/archive/v3.6.1.tar.gz && tar xf v3.6.1.tar.gz && cd json-3.6.1 && cmake -DCMAKE_INSTALL_PREFIX=$HOME/json . && make -j$(nproc) install);
    fi

script:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      cd $HOME/Library/Caches/Homebrew &&
      mv $TRAVIS_BUILD_DIR DCore--git &&
      brew install --build-bottle --verbose --HEAD DCore &&
      mv DCore--git $TRAVIS_BUILD_DIR &&
      cd $TRAVIS_BUILD_DIR;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew bottle --root-url=https://dl.bintray.com/decentfoundation/homebrew --skip-relocation DCore &&
      scripts/MacOS/prepare_dist.sh /usr/local/opt/DCore $TRAVIS_BUILD_NUMBER.$(date -u "+%H%M") &&
      pkgbuild --root scripts/MacOS/dist --component-plist scripts/MacOS/decent_pkg.plist dcore.$(ls dcore-* | sed 's/dcore-.*\.\(.*\)\.bottle\.tar\.gz/\1/').pkg;
    fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME/DCore -DCMAKE_PREFIX_PATH=$HOME/json -DBOOST_ROOT=$HOME/boost . &&
      make -j$(nproc) install;
    fi

deploy:
  skip_cleanup: true
  provider: bintray
  file: .bintray.json
  user: decent-dcore
  key:
    secure: uh3ADpcP6Ng2Jj0T2fd08y6I12SWZY2WZTquFVzOa6T4ki7C5d7JAd3Y1zkyAFHy3/X4GUoj2hUGql+XQOz3HV9DF8ou9fQu9lMtVhqQDyejNttHP77BLQeOazIM4HqgP7JXvG4o9HOOjzrwfadekMWJjFJUvVnLaUlqUvDJNR8NZrppmsp+8pZzWF4uFN9pnIJ68W5W/7/mFAzIWkJJPMC4datVpMLU+JdeWGSC5MY0cMzy9H7ol7jePqBG1IIUil8CTPY96hh9K/sXkb0dgA3SbyDY/QhlqFhNk00k8rGaefeaX08jzsXjn1oqLfMsmPWf1S3p1mqybzDr1GMl+2vm+B88MbwlhnWgcGhcPG4jclrKlj1vaYliY2nFJq6C/nN2UAtstC4NzLDgnSvDndxumP3PHqK3C8kzlxf9SZxUNG8E0pWUCLKTD3/dzxMtcedyjtI/0CQmeRksDGWWLn3ByG/CLovzHn9IrHDte6TjYDHelpdpZwR7zEoUJ2IEzwQqAeqzVdPC2op8VEG9u4UA+k4tFLSALQFicGyH/wmDeHZL8Ef1jCDJHIsN4OTowNWulxUGqlnvHI/rrWfnkFfVrvY3gbedl9Q31VWZ8kM2ZdUuDYX5K1K/ThgHYVq1ik3TCtDYB9BnEi3z5oWZllIistbMArUmSGhseN/9KAY=
  on:
    branch: develop
    condition: "$TRAVIS_OS_NAME == 'osx'"

notifications:
  email:
    on_success: never
    on_failure: always
